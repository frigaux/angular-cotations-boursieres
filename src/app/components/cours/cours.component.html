@if (date === undefined) {
  <p-skeleton shape="rectangle" borderRadius="0" width="24rem" height="2rem"/>
}

@if (date) {
  <div class="titre">
    <h3>{{ 'COMPOSANTS.COURS.MARCHES_DATE' | translate: {jour: date | date: 'dd/MM/yyyy'} }}</h3>
    <app-dialog-import-export></app-dialog-import-export>
    <app-dialog-actualites></app-dialog-actualites>
    <app-dialog-evaluation-actualites [valeurs]="valeurByTicker"></app-dialog-evaluation-actualites>
    <app-selecteur-filtre (selection)="appliquerFiltre($event)"></app-selecteur-filtre>
  </div>
}

<app-loader [affiche]="loading" [configuration]="[
  {marginLeft: '0', marginTop: '1rem', height: '3rem', width: '100%'},
  {marginLeft: '0', marginTop: '1rem', height: '3rem', width: '100%'},
  {marginLeft: '0', marginTop: '1rem', height: '3rem', width: '100%'}
]"></app-loader>

<app-popover-actions-valeur></app-popover-actions-valeur>

<div class="conteneur" [ngClass]="{'avec-details': coursSelectionne !== undefined}">
  @if (!loading && marches) {
    <p-accordion [(value)]="idxMarcheCourant">
      @for (marche of marches; track marche.libelle; let i = $index) {
        <p-accordion-panel [value]="i">
          <p-accordion-header>{{ marche.libelle }}</p-accordion-header>
          <p-accordion-content>
            <p-table
              sortField="libelle"
              (sortFunction)="trierColonne($event, marche)" [customSort]="true"
              [scrollable]="true" scrollHeight="calc(100vh - 26rem)"
              [style]="{ margin: '1rem' }"
              [tableStyle]="{'table-layout': 'fixed'}"
              [value]="marche.cours"
              [loading]="loading">
              <ng-template #header>
                <tr>
                  <th pSortableColumn="libelle">
                    {{ 'COMPOSANTS.COURS.LIBELLE' | translate }}
                    <p-sortIcon field="libelle"/>
                    <p-columnFilter type="text" field="libelle" matchMode="contains" display="menu"
                                    [showMatchModes]="false"
                                    [showOperator]="false" [showAddButton]="false"/>
                  </th>
                  <th pSortableColumn="var1">
                    {{ 'COMPOSANTS.COURS.VAR1' | translate }}
                    <p-sortIcon field="var1"/>
                  </th>
                  <th pSortableColumn="cloture">
                    {{ 'COMPOSANTS.COURS.CLOTURE' | translate }}
                    <p-sortIcon field="cloture"/>
                  </th>
                  <th pSortableColumn="plusBas">
                    {{ 'COMPOSANTS.COURS.MM5' | translate }}
                  </th>
                  <th pSortableColumn="plusHaut">
                    {{ 'COMPOSANTS.COURS.MM20' | translate }}
                  </th>
                  <th pSortableColumn="volume">
                    {{ 'COMPOSANTS.COURS.MM50' | translate }}
                  </th>
                </tr>
              </ng-template>
              <ng-template #body let-cours>
                <tr (click)="onClickCours($event, marche, cours)">
                  <td>
                    <span class="pi"
                          [class]="cours.iconeVariation()"
                          title="{{ 'COMPOSANTS.COURS.ACTIONS' | translate }}"></span>
                    {{ cours.libelle }}
                  </td>
                  <td [class]="VueUtil.evolutionVariation(cours.var1)">
                    {{ cours.var1 | percent:'1.2-2' }}
                  </td>
                  <td>{{ cours.cloture | currency:'€' }}</td>
                  <td [class]="evolutionCours(cours.cloture, cours.moyennesMobiles[4])">
                    {{ cours.moyennesMobiles[4] | currency:'€' }}
                  </td>
                  <td [class]="evolutionCours(cours.cloture, cours.moyennesMobiles[19])">
                    {{ cours.moyennesMobiles[19] | currency:'€' }}
                  </td>
                  <td [class]="evolutionCours(cours.cloture, cours.moyennesMobiles[49])">
                    {{ cours.moyennesMobiles[49] | currency:'€' }}
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </p-accordion-content>
        </p-accordion-panel>
      }
    </p-accordion>

    <app-details-valeur [cours]="coursSelectionne" (ferme)="coursSelectionne = undefined"
                        (precedent)="valeurPrecedente()" (suivant)="valeurSuivante()"></app-details-valeur>
  }
</div>
