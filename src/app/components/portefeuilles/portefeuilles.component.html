<h3>{{ 'COMPOSANTS.PORTEFEUILLES.PORTEFEUILLES_DATE' | translate }}
  <p-skeleton *ngIf="date === undefined" shape="rectangle" borderRadius="0" width="6rem" height="1rem"/>
  {{ date | date: 'dd/MM/yyyy' }}
</h3>

<app-loader [affiche]="loading" [configuration]="[
  {marginLeft: '0', height: '2rem', width: '100%'},
  {marginLeft: '2rem', height: '45vh', width: '100%'},
  {marginLeft: '0', height: '2rem', width: '100%'},
  {marginLeft: '0', height: '2rem', width: '100%'},
  {marginLeft: '0', height: '2rem', width: '100%'}
]"></app-loader>

<app-achat-valeur></app-achat-valeur>

@if (portefeuillesAvecCours) {
  <div class="conteneur" [ngClass]="{'avec-details': coursSelectionne !== undefined}">
    <p-accordion *ngIf="!loading" value="{{idxPortefeuilleCourant}}" (onOpen)="onOpenAccordion($event)">
      @for (portefeuilleAvecCours of portefeuillesAvecCours; track portefeuilleAvecCours.portefeuille.nom; let
        i = $index) {
        <p-accordion-panel value="{{i}}">
          <p-accordion-header>{{ portefeuilleAvecCours.portefeuille.nom }}</p-accordion-header>
          <p-accordion-content>
            <p-table
              sortField="{{idColonneTriParDefaut}}"
              [scrollable]="true" scrollHeight="calc(100vh - 20rem)"
              [style]="{ margin: '1rem' }"
              [value]="portefeuilleAvecCours.cours"
              [loading]="loading">
              <ng-template #header>
                <tr>
                  @for (colonneDecoree of colonnesDecorees; track colonneDecoree.id) {
                    @if (colonneDecoree.colonne.tri) {
                      <th pSortableColumn="{{colonneDecoree.id}}"
                          [ngStyle]="{'width': `${colonneDecoree.colonne.largeur}%`, 'text-align': colonneDecoree.textAlign}">
                        {{ colonneDecoree.colonne.nom }}
                        <p-sortIcon field="{{colonneDecoree.id}}"/>
                      </th>
                    } @else {
                      <th
                        [ngStyle]="{'width': `${colonneDecoree.colonne.largeur}%`, 'text-align': colonneDecoree.textAlign}">
                        {{ colonneDecoree.colonne.nom }}
                      </th>
                    }
                  }
                </tr>
              </ng-template>
              <ng-template #body let-cours>
                <tr>
                  @for (colonneDecoree of colonnesDecorees; track colonneDecoree.id) {
                    <td
                      [ngStyle]="{'text-align': colonneDecoree.textAlign}"
                      [class]="classeCss(colonneDecoree, cours)"
                      (click)="onClickCours($event, cours, portefeuilleAvecCours.portefeuille)">
                      @if (colonneDecoree.id === 0) {
                        <span class="pi"
                              [class]="classeIconeVariation(cours.var1)"
                              title="{{ 'COMPOSANTS.PORTEFEUILLES.ACTIONS' | translate }}"></span>
                      }
                      @switch (colonneDecoree.colonne.type) {
                        @case (TypesColonnesPortefeuille.DATE) {
                          {{ cours[colonneDecoree.id] | date: 'dd/MM/yyyy' }}
                        }
                        @case (TypesColonnesPortefeuille.MARCHE) {
                          {{ `ENUMERATIONS.MARCHE.${cours[colonneDecoree.id]}` | translate }}
                        }
                        @case (TypesColonnesPortefeuille.OUVERTURE) {
                          {{ cours[colonneDecoree.id] | currency:'€' }}
                        }
                        @case (TypesColonnesPortefeuille.PLUS_HAUT) {
                          {{ cours[colonneDecoree.id] | currency:'€' }}
                        }
                        @case (TypesColonnesPortefeuille.PLUS_BAS) {
                          {{ cours[colonneDecoree.id] | currency:'€' }}
                        }
                        @case (TypesColonnesPortefeuille.CLOTURE) {
                          {{ cours[colonneDecoree.id] | currency:'€' }}
                        }
                        @case (TypesColonnesPortefeuille.VOLUME) {
                          {{ cours[colonneDecoree.id] | number }}
                        }
                        @case (TypesColonnesPortefeuille.ALERTES) {
                          <app-alertes [alertes]="cours[colonneDecoree.id]"></app-alertes>
                        }
                        @case (TypesColonnesPortefeuille.VARIATION_ACHATS) {
                          {{ cours[colonneDecoree.id] | percent:'1.2-2' }}
                        }
                        @case (TypesColonnesPortefeuille.COURS) {
                          {{ cours[colonneDecoree.id] | currency:'€' }}
                        }
                        @case (TypesColonnesPortefeuille.MOYENNE_MOBILE) {
                          {{ cours[colonneDecoree.id] | currency:'€' }}
                        }
                        @case (TypesColonnesPortefeuille.VARIATION) {
                          {{ cours[colonneDecoree.id] | percent:'1.2-2' }}
                        }
                        @default {
                          {{ cours[colonneDecoree.id] }}
                        }
                      }
                    </td>
                  }
                </tr>
              </ng-template>
            </p-table>
          </p-accordion-content>
        </p-accordion-panel>
      }
    </p-accordion>

    <app-details-valeur [cours]="coursSelectionne" (ferme)="coursSelectionne = undefined"></app-details-valeur>
  </div>
}
