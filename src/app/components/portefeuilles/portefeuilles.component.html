@if (date === undefined) {
  <p-skeleton shape="rectangle" borderRadius="0" width="100%" height="2rem"/>
}

@if (date) {
  <div class="titre">
    <h2>{{ 'COMPOSANTS.PORTEFEUILLES.PORTEFEUILLES_DATE' | translate: {jour: date | date: 'dd/MM/yyyy'} }}</h2>
    <app-dialog-actualites></app-dialog-actualites>
    <app-dialog-evaluation-actualites [valeurs]="valeurByTicker"></app-dialog-evaluation-actualites>
    <app-sauvegarde-restauration [reduit]="true"></app-sauvegarde-restauration>
  </div>
}

<app-popover-actions-valeur></app-popover-actions-valeur>

@if (portefeuillesAvecCours) {
  <div class="conteneur" [ngClass]="{'avec-details': coursSelectionne !== undefined}">
    <p-tabs [(value)]="idxPortefeuilleCourant">
      <p-tablist>
        @for (portefeuilleAvecCours of portefeuillesAvecCours; track portefeuilleAvecCours.portefeuille.nom; let
          i = $index) {
          <p-tab [value]="i" (click)="onClickTab()">
            {{ portefeuilleAvecCours.portefeuille.nom }}
          </p-tab>
        }
      </p-tablist>
      <p-tabpanels>
        @for (portefeuilleAvecCours of portefeuillesAvecCours; track portefeuilleAvecCours.portefeuille.nom; let
          i = $index) {
          <p-tabpanel [value]="i">
            @if (loading) {
              <app-loader [affiche]="loading" [configuration]="[
                {marginLeft: '0', marginTop: '1rem', height: '30rem', width: '100%'},
              ]"></app-loader>
            } @else {
              <p-table
                sortField="{{idColonneTriParDefaut}}"
                [scrollable]="true" scrollHeight="calc(100vh - 20rem)"
                [style]="{ margin: '1rem' }"
                [tableStyle]="{'table-layout': 'fixed'}"
                [value]="portefeuilleAvecCours.cours"
                [loading]="loading">
                <ng-template #header>
                  <tr>
                    @for (colonneDecoree of colonnesDecorees; track colonneDecoree.id) {
                      @if (colonneDecoree.colonne.tri) {
                        <th pSortableColumn="{{colonneDecoree.id}}"
                            [ngStyle]="{'width': `${colonneDecoree.colonne.largeur}%`, 'text-align': colonneDecoree.textAlign}">
                          {{ colonneDecoree.colonne.nom }}
                          <p-sortIcon field="{{colonneDecoree.id}}"/>
                        </th>
                      } @else {
                        <th
                          [ngStyle]="{'width': `${colonneDecoree.colonne.largeur}%`, 'text-align': colonneDecoree.textAlign}">
                          {{ colonneDecoree.colonne.nom }}
                        </th>
                      }
                    }
                  </tr>
                </ng-template>
                <ng-template #body let-cours>
                  <tr (click)="onClickCours($event, cours, portefeuilleAvecCours)">
                    @for (colonneDecoree of colonnesDecorees; track colonneDecoree.id) {
                      <td
                        [ngStyle]="{'text-align': colonneDecoree.textAlign}"
                        [ngClass]="{'libelle': colonneDecoree.colonne.type === TypesColonnesPortefeuille.LIBELLE}"
                        [class]="evolutionColonne(colonneDecoree, cours)">
                        @if (colonneDecoree.id === 0) {
                          <span class="pi"
                                [class]="VueUtil.iconeVariation(cours.var1)"
                                title="{{ 'COMPOSANTS.PORTEFEUILLES.ACTIONS' | translate }}"></span>
                        }
                        @switch (colonneDecoree.colonne.type) {
                          @case (TypesColonnesPortefeuille.DATE) {
                            {{ cours[colonneDecoree.id] | date: 'dd/MM/yyyy' }}
                          }
                          @case (TypesColonnesPortefeuille.MARCHE) {
                            {{ `ENUMERATIONS.MARCHE.${cours[colonneDecoree.id]}` | translate }}
                          }
                          @case (TypesColonnesPortefeuille.OUVERTURE) {
                            {{ cours[colonneDecoree.id] | currency:'EUR':'symbol' }}
                          }
                          @case (TypesColonnesPortefeuille.PLUS_HAUT) {
                            {{ cours[colonneDecoree.id] | currency:'EUR':'symbol' }}
                          }
                          @case (TypesColonnesPortefeuille.PLUS_BAS) {
                            {{ cours[colonneDecoree.id] | currency:'EUR':'symbol' }}
                          }
                          @case (TypesColonnesPortefeuille.CLOTURE) {
                            {{ cours[colonneDecoree.id] | currency:'EUR':'symbol' }}
                          }
                          @case (TypesColonnesPortefeuille.VOLUME) {
                            {{ cours[colonneDecoree.id] | number }}
                          }
                          @case (TypesColonnesPortefeuille.ALERTES) {
                            <app-colonne-alertes [alertes]="cours[colonneDecoree.id]"></app-colonne-alertes>
                          }
                          @case (TypesColonnesPortefeuille.VARIATION_ACHATS) {
                            {{ cours[colonneDecoree.id] | percent:'1.2-2' }}
                          }
                          @case (TypesColonnesPortefeuille.COURS) {
                            {{ cours[colonneDecoree.id] | currency:'EUR':'symbol' }}
                          }
                          @case (TypesColonnesPortefeuille.MOYENNE_MOBILE) {
                            {{ cours[colonneDecoree.id] | currency:'EUR':'symbol' }}
                          }
                          @case (TypesColonnesPortefeuille.VARIATION) {
                            {{ cours[colonneDecoree.id] | percent:'1.2-2' }}
                          }
                          @case (TypesColonnesPortefeuille.DIVIDENDES) {
                            <app-colonne-dividendes [reduit]="true" [dividendes]="cours[colonneDecoree.id]"></app-colonne-dividendes>
                          }
                          @default {
                            {{ cours[colonneDecoree.id] }}
                          }
                        }
                      </td>
                    }
                  </tr>
                </ng-template>
              </p-table>
            }
          </p-tabpanel>
        }
      </p-tabpanels>
    </p-tabs>

    <app-details-valeur [cours]="coursSelectionne" (ferme)="coursSelectionne = undefined"></app-details-valeur>
  </div>
}
